<!-- build time: Sun Apr 07 2024 15:19:36 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"><meta name="renderer" content="webkit"><link rel="icon" type="image/ico" sizes="32x32" href="/assets/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="alternate" href="/rss.xml" title="个人博客" type="application/rss+xml"><link rel="alternate" href="/atom.xml" title="个人博客" type="application/atom+xml"><link rel="alternate" type="application/json" title="个人博客" href="https://seele-exzzz.github.io/feed.json"><link rel="preconnect" href="https://lf9-cdn-tos.bytecdntp.com"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://unpkg.com"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.10"><script src="https://cdn.staticfile.org/vue/3.2.45/vue.global.prod.js"></script><meta name="keywords" content="webrtc"><link rel="canonical" href="https://seele-exzzz.github.io/2023/11/27/Video-Audio/%E7%AB%AF%E5%AF%B9%E7%AB%AF%E8%BF%9E%E6%8E%A5%E5%88%9D%E4%BD%93%E9%AA%8C/"><title>端对端连接初体验</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">端对端连接初体验</h1><div class="meta"><span class="item" title="创建时间：2023-11-27 10:48:55"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">发表于</span><time itemprop="dateCreated datePublished" datetime="2023-11-27T10:48:55+08:00">2023-11-27</time></span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i></span><span class="text">本文字数</span><span>6.7k</span><span class="text">字</span></span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i></span><span class="text">阅读时长</span><span>6 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">testName</a></li></ul><ul class="right" id="rightNav"><li class="item theme" @click="changeThemeByBtn"><i class="ic" :class="{'i-sun': !themeStatus,'i-moon': themeStatus}"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><ul><li class="item" data-background-image="https://typora-seele-exzzz.oss-cn-guangzhou.aliyuncs.com/img/coverY0xvg.jpg"></li><li class="item" data-background-image="https://typora-seele-exzzz.oss-cn-guangzhou.aliyuncs.com/img/coverv2-b0134090723fe0b1454cecdc483e1fe4_720w.webp"></li><li class="item" data-background-image="https://typora-seele-exzzz.oss-cn-guangzhou.aliyuncs.com/img/coverYQSYM.jpg"></li><li class="item" data-background-image="https://typora-seele-exzzz.oss-cn-guangzhou.aliyuncs.com/img/coverv2-85ed8bed82356bc42302df4685eb4667_720w.webp"></li><li class="item" data-background-image="https://typora-seele-exzzz.oss-cn-guangzhou.aliyuncs.com/img/cover/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20230717194131.png"></li><li class="item" data-background-image="https://typora-seele-exzzz.oss-cn-guangzhou.aliyuncs.com/img/cover/4440c7ccdd32d41726b5070ebbe83b12_3889824641741254187.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemlistelement itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/">首页</a></span><i class="ic i-angle-right"></i><span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/Video-Audio/" itemprop="item" rel="index" title="分类于音视频开发"><span itemprop="name">音视频开发<meta itemprop="position" content="0"></span></a></span></div><article class="post block" itemscope itemtype="http://schema.org/Article" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://seele-exzzz.github.io/2023/11/27/Video-Audio/%E7%AB%AF%E5%AF%B9%E7%AB%AF%E8%BF%9E%E6%8E%A5%E5%88%9D%E4%BD%93%E9%AA%8C/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/assets/avatar.jpg"><meta itemprop="name" content="SEELE-EXZzz(纯希)"><meta itemprop="description" content=", "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="个人博客"></span><div class="body md" itemprop="articleBody"><h3 id="端对端连接初体验"><a class="markdownIt-Anchor" href="#端对端连接初体验">#</a> 端对端连接初体验</h3><h4 id="一-nat-stun-turn"><a class="markdownIt-Anchor" href="#一-nat-stun-turn">#</a> 一、NAT STUN TURN</h4><ol><li>NAT</li></ol><p>NAT 全称 Network Addresss Translation 即网络地址转换。出现的目的是为了解决 ipv4 不够用的情况同时还能保证内网安全，缺点在于 nat 会降低网速，nat 层数越多网速越慢，同时 nat 如果两边都是对称型或者一边是对称型另一边是端口限制性，就无法进行 p2p 连接了。由于 ipv4 数量不够，不足以让每台设备都拥有一个 ipv4，同时 ipv6 还未普及。所以需要 nat 将内网 ip 转化为公网 ip 中的某个端口。一般一个路由器有一个公网 ip，同时路由器会给连接上路由器的设备一个内网 ip。其中内网 ip 有三类：A 类：10.0.0.0–10.255.255.255，B 类：172.16.0.0–172.31.255.255，c 类：192.168.0.0–192.168.255.255。路由器内的设备在访问外网时，内网 ip 地址经过路由器会映射为路由器外网 ip 地址中的某个端口号，发给某个网站的服务器，此时服务器收到的 ip 地址是路由器的 ip 地址的某个端口而不是内网 ip 地址。路由器收到网站返回的响应，会根据映射表发给相应的内网 ip 的设备。</p><p>NAT 有两大类型一个是锥型，另一个是对称型。当路由器内的设备访问某个网站时，路由器会生成一个外网 ip 地址，如果此时在访问另一个网站，路由器生成的外网 ip 地址也是同一个，这就是锥型，如果不同则是对称型。换句话说如果设备在访问不同的网站时，经由 NAT 生成的 ip 地址如果是同一个就是锥型，不同则是对称型。</p><p>锥型还分为三种，分别是完全锥型，地址受限锥型，端口受限锥型。如果能通过 NAT 生成的 ip 地址，向该地址发生消息，内网的设备能够直接接收到该消息则是完全锥型，如果要求该内网设备发消息给某个服务器，这个服务器才能通过 NAT 生成的 ip 地址发给该内网设备则是地址受限锥型。如果要求该内网设备发消息给某个服务器，且消息必须由该服务器上收到消息的端口号发送，通过 NAT 生成的 ip 地址发送消息给内网设备则是端口受限锥型。简单的讲如果任何设备都可以通过由 NAT 映射的 ip 地址访问内网设备则是完全锥型，如果需要该内网设备访问过的设备，才能访问内网设备则是地址受限锥型。如果不仅要该内网设备访问过的设备，发送消息时还必须通过接收消息的端口号发送消息，才能访问内网设备则是端口受限锥型。</p><p>从宽松程度来看，完全锥型 &lt; 地址受限锥型 &lt; 端口受限锥型 &lt; 对称型 完全锥型最宽松，对称型最严格。</p><p>从安全角度来看，完全锥型 &lt; 地址受限锥型 &lt; 端口受限锥型 &lt; 对称型。完全锥型最不安全，对称型最安全。</p><ol start="2"><li>STUN</li></ol><p>STUN 全称 Simple Traversal of UDP Through NATs，即简单的用 udp 实现 NAT 穿越。如果两个设备拥有公网 ip，那么这两个设备就能互相访问对方也就很轻易的完成 p2p 连接。但现实是，由于 ipv4 紧缺导致设备一般没有公网 ip，用的是由 NAT 分配的内网 ip，而内网 ip 则不能直接访问。这个时候就需要用到 STUN 进行 NAT 穿越，获取设备内网 ip 经由路由器映射下的公网 ip 地址，然后交换双方的公网 ip 地址以实现 p2p 连接。当然并不是所有设备都能 p2p 连接的，如果双方的 NAT 是对称型的或者有一方是对称型另一方是端口受限锥型则无法进行 p2p 连接，这时候就需要使用 TURN</p><p>使用 STUN 时，需要在双方设置 STUN 客户端，以及一个双方能访问到的 STUN 服务器 (一般部署到公网上) 。STUN 客户端和 STUN 服务器需要进行至多三次测试，用于判断双方的 NAT 类型，是否能用 UDP 传输以及双方在 NAT 映射下的公网 ip 地址以及端口号。测试如下，图片来自 wiki。</p><p><img data-src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/35/STUN_Algorithm3_zh_Hans.svg/1280px-STUN_Algorithm3_zh_Hans.svg.png" alt="undefined"></p><ol start="3"><li>TURN</li></ol><p>TURN 全称 Traversal Using Relays around NAT，即使用中继实现 NAT 穿越。当通信双方的 NAT 是对称型的或者有一方是对称型另一方是端口受限锥型则无法进行 p2p 连接。这时候就需要使用 TURN 服务器，获取通信双方的音视频相关的数据，再交换。使用 TURN 作中继相比 p2p 连接，延迟要高且耗费流量，如果 TURN 服务器的带宽不够还会降低双方的通信质量，这是无法进行 p2p 连接的无奈之举。</p><p>相关资料：</p><p>[Ref]:<span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC9mNzE3MDc4OTJlYjI="> 详解 P2P 技术中的 NAT 穿透原理 (转载) - 简书 (jianshu.com)</span></p><p>[Ref]:<span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC85YmZiY2JlZTBhYmI=">P2P 技术详解 (二)：P2P 中的 NAT 穿越 (打洞) 方案详解 - 简书 (jianshu.com)</span></p><p>[Ref]: <span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC8yNThlN2Q4YmUyYmE=">P2P 技术详解 (三)：P2P 技术之 STUN、TURN、ICE 详解 (转载) - 简书 (jianshu.com)</span></p><h4 id="二-candidate-ice-sdp"><a class="markdownIt-Anchor" href="#二-candidate-ice-sdp">#</a> 二、Candidate ICE SDP</h4><ol><li><p>candidate 意为候选者，有三种类型分别为 host，srflx，relay。优先度由高到低。</p><p>host：如果通信双方处于一个局域网下或者说连接同一个 wife。就可以使用这个类型，优势度最高。具体收集的是，ip 地址和端口。</p><p>srflx：如果通信双方不在同一个局域网但可以进行 p2p 连接，则可以走这个类型。优先度仅此于 host</p><p>relay：如果双方无法进行 p2p 连接即双方可能是对称型或者一方对称另一方端口限制型的话，则选择这个类型。优先度最低，只有上面两种不行无法进行 p2p 连接才会选择。relay 和 srflx 收集的是经过 NAT 映射后的 ip 地址和端口。</p></li><li><p>ice：全称 Interactive Connectivity Establishment（交互式连通建立方式）。ice 收集所有通信方式并找到一个最佳的通信方式。比如通过 STUN 找到 srflx 类型的 candidate，通过 TURN 找到 relay 类型的 candidate。优先使用 host，如果不通则尝试 srflx，如果还不通最后使用 relay。</p></li><li><p>SDP：全称 Session Description Protocol（会话描述协议）。通信双方的设备支持的视频和音频的编解码很大概率是不同，所以需要了解通信双方所支持的音视频编解码，然后从中选择一个双方都有且最好的音视频编解码。sdp 记录了某一方支持的音视频编解码。</p></li></ol><h4 id="三-rtcpeerconnection"><a class="markdownIt-Anchor" href="#三-rtcpeerconnection">#</a> 三、RTCPeerConnection</h4><p>RTCPeerConnection 是一个构造函数，用于创建 offer 和 answer，设置本地的 sdp 信息以及远端的 sdp 信息。在媒体协商前需将媒体流使用 addstream 或者 addtrack 设置到 RTCPeerConnection 的实例对象中。在设置完媒体流后需要进行媒体协商，发起方需要创建 offer，将 offer 设置为本地的 sdp 信息同时发送给信令服务器。接收方收到信令服务器发送的 offer，将 offer 设置为本地描述，然后创建 answer，将 answer 设置为本地描述同时发送 answer 到信令服务器。接收方收到信令服务器的 answer 将设置远端描述。至此媒体协商完成，在 webrtc 底层会收集 candidate，此时还需要交换双方的 candidate，当交换完成就会使用 ice 找到合适的连接方式。这时候通信双方建立了一条链路。音视频数据可以通过这个链路传输了。当收到远端传来的数据还需要在本地展示出来。需注意的是，需要给 RTCPeerConnection 设置媒体流，在设置本地描述后就会触发 onicecandidate，如果在设置本地描述前没有设置媒体流的话是不会触发 oniecandidate 的。另外接收方将发送方发送的 offer 设置为远端描述后才能创建 answer。整个流程如下。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">let local = document.querySelector(&#x27;#local&#x27;) </span><br><span class="line">let remote = document.querySelector(&#x27;#remote&#x27;)</span><br><span class="line">let stream </span><br><span class="line">//连接信令服务器</span><br><span class="line">const socket = io(&#x27;http://localhost:3000&#x27;)</span><br><span class="line">socket.on(&#x27;connect&#x27;,()=&gt;&#123;console.log(&#x27;连接成功&#x27;)&#125;)</span><br><span class="line">async function getvideo (pc)&#123;</span><br><span class="line">    stream = await navigator.mediaDevices.getUserMedia(&#123;video:true,audio:false&#125;)</span><br><span class="line">    getOffer()</span><br><span class="line">&#125;</span><br><span class="line">getvideo()</span><br><span class="line">//pc1为发送方</span><br><span class="line">let pc1 = new RTCPeerConnection()</span><br><span class="line">async function getOffer()&#123;</span><br><span class="line">    await pc1.addStream(stream) //先设置媒体流然后再创建offer将offer设置到本地描述这时候就会触发onicecandidate。</span><br><span class="line">    let offer = await pc1.createOffer() //获取发送方的offer</span><br><span class="line">    await pc1.setLocalDescription(offer) //将发送方的offer设置到本地描述</span><br><span class="line">    socket.emit(&#x27;sendOffer&#x27;,offer) //将offer传输到信令服务器</span><br><span class="line">&#125;</span><br><span class="line">socket.on(&#x27;getAnswer&#x27;,async(answer)=&gt;&#123;</span><br><span class="line">    await pc1.setRemoteDescription(answer) //将接收方的answer设置到远端描述。      </span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">pc1.onicecandidate=(e)=&gt;&#123;</span><br><span class="line">    if(e.candidate)&#123;</span><br><span class="line">        socket.emit(&#x27;candidate&#x27;,e.candidate,&#x27;pc1&#x27;) //当发送方将offer设置到本地描述就会不断触发这个事件，此时的e.candidate有可能是null所以需加一层判断</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pc1.ontrack=(e)=&gt;&#123;</span><br><span class="line">    local.srcObject = e.streams[0]</span><br><span class="line">    local.play()</span><br><span class="line">&#125; //当远程描述设置完成就会触发ontrack</span><br><span class="line"></span><br><span class="line">socket.on(&#x27;sendCandidate&#x27;,async(candidate,type)=&gt;&#123;</span><br><span class="line">    if(type===&#x27;pc1&#x27;)&#123;</span><br><span class="line">        await pc2.addIceCandidate(candidate) //接收方用addicecandidate接收发送方的candidate</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        await pc1.addIceCandidate(candidate) //发送方用addicecandidate接收接收方的candidate</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">//pc2为接收方</span><br><span class="line">let pc2 = new RTCPeerConnection()</span><br><span class="line">socket.on(&#x27;getOffer&#x27;,async(offer)=&gt;&#123;</span><br><span class="line">    await pc2.addStream(stream) //先设置媒体流，然后将发送方的offer设置到远端描述，这时候才能创建answer，再将创建的answer设置到本地描述。这时候就会触发onicecandidate。</span><br><span class="line">    await pc2.setRemoteDescription(offer) //将发送方的offer设置到远端描述</span><br><span class="line">    let answer = await pc2.createAnswer() //获取接收方的answer</span><br><span class="line">    await pc2.setLocalDescription(answer) //将接收方的answer设置到本地描述</span><br><span class="line">    socket.emit(&#x27;sendAnswer&#x27;,answer) //将answer传输到信令服务器    </span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">pc2.onicecandidate=(e)=&gt;&#123;</span><br><span class="line">    if(e.candidate)&#123;</span><br><span class="line">    	//当接受方将answer设置到本地描述就会不断触发这个事件，因为e.candidate有可能是null所以这里加个判断</span><br><span class="line">        socket.emit(&#x27;candidate&#x27;,e.candidate,&#x27;pc2&#x27;) </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pc2.ontrack=(e)=&gt;&#123;</span><br><span class="line">    remote.srcObject = e.streams[0]</span><br><span class="line">    remote.play()</span><br><span class="line">&#125; //当远程描述设置完成就会触发ontrack</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//信令服务器</span><br><span class="line">const express = require(&quot;express&quot;);</span><br><span class="line">const &#123; createServer &#125; = require(&quot;http&quot;);</span><br><span class="line">const &#123; Server &#125; = require(&quot;socket.io&quot;);</span><br><span class="line"></span><br><span class="line">const app = express();</span><br><span class="line">const httpServer = createServer(app);</span><br><span class="line">const io = new Server(httpServer,&#123;</span><br><span class="line">	cors : &#x27;127.0.0.1:5500&#x27; //允许请求的地址 </span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">io.on(&quot;connection&quot;, (socket) =&gt; &#123;</span><br><span class="line">	socket.on(&#x27;sendOffer&#x27;,(offer)=&gt;&#123;</span><br><span class="line">		socket.emit(&#x27;getOffer&#x27;,offer)</span><br><span class="line">	&#125;)</span><br><span class="line">	socket.on(&#x27;sendAnswer&#x27;,(answer)=&gt;&#123;</span><br><span class="line">		socket.emit(&#x27;getAnswer&#x27;,answer)</span><br><span class="line">	&#125;)</span><br><span class="line">  	socket.on(&#x27;candidate&#x27;,(candidate)=&gt;&#123;</span><br><span class="line">		socket.emit(&#x27;sendCandidate&#x27;,candidate)</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">httpServer.listen(3000);</span><br></pre></td></tr></table></figure><p>相关资料：</p><p><span class="exturl" data-url="aHR0cHM6Ly9qdWVqaW4uY24vcG9zdC83MjY2NDE3OTQyMTgyNjA4OTU1">WebRTC 这么火🔥，前端靓仔，请收下这篇入门教程 - 掘金 (juejin.cn)</span></p><h4 id="四-rtcdatachannel"><a class="markdownIt-Anchor" href="#四-rtcdatachannel">#</a> 四、RTCDataChannel</h4><p>可以使用 RTCDataChannel 可以传输文本，文件以及图片。RTCDataChannel 是由 RTCPeerConnection 实例对象的 createDataChannel () 创建的。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">let channel = pc1.createDataChannel(&#x27;chat&#x27;) //使用createDataChannel创建通道，第一个参数是通道的名字</span><br><span class="line">let channel1 = pc1.createDataChannel(&#x27;123&#x27;)</span><br><span class="line">channel.onopen=(e)=&gt;&#123; //通道建立后触发这个onopen事件</span><br><span class="line">    channel.send(&#x27;hello,world&#x27;) //可以使用send方法发送消息</span><br><span class="line">&#125;</span><br><span class="line">channel.onmessage=(e)=&gt;&#123;</span><br><span class="line">    console.log(e.data,&#x27;pc1&#x27;) //接收消息</span><br><span class="line">&#125;</span><br><span class="line">//每当建立一个通道就会触发ondatachannel</span><br><span class="line">pc2.ondatachannel=(e)=&gt;&#123; </span><br><span class="line">    let channel = e.channel</span><br><span class="line">    channel.onopen=(e)=&gt;&#123;</span><br><span class="line">		channel.send(&#x27;你好世界&#x27;)</span><br><span class="line">    &#125;</span><br><span class="line">    channel.onmessage=(e)=&gt;&#123;</span><br><span class="line">        console.log(e.data,&#x27;pc2&#x27;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="tags"><a href="/tags/webrtc/" rel="tag"><i class="ic i-tag"></i>webrtc</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">更新于</span><time title="修改时间：2024-01-20 16:41:54" itemprop="dateModified" datetime="2024-01-20T16:41:54+08:00">2024-01-20</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i>赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/assets/wechatpay.png" alt="SEELE-EXZzz(纯希) 微信支付"><p>微信支付</p></div><div><img data-src="/assets/alipay.png" alt="SEELE-EXZzz(纯希) 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者：</strong>SEELE-EXZzz(纯希)<i class="ic i-at"><em>@</em></i>个人博客</li><li class="link"><strong>本文链接：</strong><a href="https://seele-exzzz.github.io/2023/11/27/Video-Audio/%E7%AB%AF%E5%AF%B9%E7%AB%AF%E8%BF%9E%E6%8E%A5%E5%88%9D%E4%BD%93%E9%AA%8C/" title="端对端连接初体验">https://seele-exzzz.github.io/2023/11/27/Video-Audio/端对端连接初体验/</a></li><li class="license"><strong>版权声明：</strong>本站所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2023/11/22/Video-Audio/%E5%B9%BB%E5%BD%B1%E5%9D%A6%E5%85%8B%E5%88%B6%E5%A4%87/" rel="prev" itemprop="url" data-background-image="https:&#x2F;&#x2F;typora-seele-exzzz.oss-cn-guangzhou.aliyuncs.com&#x2F;img&#x2F;cover&#x2F;%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20230717194834.png" title="幻影坦克制备"><span class="type">上一篇</span><span class="category"><i class="ic i-flag"></i>音视频开发</span><h3>幻影坦克制备</h3></a></div><div class="item right"><a href="/2024/01/13/3d-modeling/%E5%88%9D%E8%AF%86glsl/" rel="next" itemprop="url" data-background-image="https:&#x2F;&#x2F;typora-seele-exzzz.oss-cn-guangzhou.aliyuncs.com&#x2F;img&#x2F;cover&#x2F;f24fc4c348355db0293826144c1dae55_475017614100612969.jpg" title="初识glsl"><span class="type">下一篇</span><span class="category"><i class="ic i-flag"></i>计算机图形学</span><h3>初识glsl</h3></a></div></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AB%AF%E5%AF%B9%E7%AB%AF%E8%BF%9E%E6%8E%A5%E5%88%9D%E4%BD%93%E9%AA%8C"><span class="toc-number">1.</span> <span class="toc-text">端对端连接初体验</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80-nat-stun-turn"><span class="toc-number">1.1.</span> <span class="toc-text">一、NAT STUN TURN</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C-candidate-ice-sdp"><span class="toc-number">1.2.</span> <span class="toc-text">二、Candidate ICE SDP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89-rtcpeerconnection"><span class="toc-number">1.3.</span> <span class="toc-text">三、RTCPeerConnection</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9B-rtcdatachannel"><span class="toc-number">1.4.</span> <span class="toc-text">四、RTCDataChannel</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/2023/11/07/Video-Audio/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%9F%BA%E7%A1%80/" rel="bookmark" title="二进制基础">二进制基础</a></li><li><a href="/2023/11/09/Video-Audio/webrtc%E5%9F%BA%E7%A1%80/" rel="bookmark" title="webrtc基础">webrtc基础</a></li><li><a href="/2023/11/11/Video-Audio/canvas%E5%AF%B9%E5%9B%BE%E7%89%87%E5%A4%84%E7%90%86/" rel="bookmark" title="canvas对图片处理">canvas对图片处理</a></li><li><a href="/2023/11/13/Video-Audio/canvas%E5%AF%B9%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86/" rel="bookmark" title="canvas对视频处理">canvas对视频处理</a></li><li><a href="/2023/11/14/Video-Audio/websocket%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/" rel="bookmark" title="websocket的基本使用">websocket的基本使用</a></li><li><a href="/2023/11/22/Video-Audio/%E5%B9%BB%E5%BD%B1%E5%9D%A6%E5%85%8B%E5%88%B6%E5%A4%87/" rel="bookmark" title="幻影坦克制备">幻影坦克制备</a></li><li class="active"><a href="/2023/11/27/Video-Audio/%E7%AB%AF%E5%AF%B9%E7%AB%AF%E8%BF%9E%E6%8E%A5%E5%88%9D%E4%BD%93%E9%AA%8C/" rel="bookmark" title="端对端连接初体验">端对端连接初体验</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="SEELE-EXZzz(纯希)" data-src="/assets/avatar.jpg"><p class="name" itemprop="name">SEELE-EXZzz(纯希)</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">31</span><span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">5</span><span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">19</span><span class="name">标签</span></a></div></nav><div class="social"><a href="https://github.com/SEELE-EXZzz" class="item github" rel="noopener" title="https:&#x2F;&#x2F;github.com&#x2F;SEELE-EXZzz" target="_blank"><i class="ic i-github"></i></a></div><div class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-user"></i>关于</a><ul class="submenu"><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于本站</a></li><li class="item"><a href="/admiration/" rel="section"><i class="ic i-coffee"></i>赞赏博主</a></li></ul></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a></li><li class="item dropdown"><a href="/page/" rel="section"><i class="ic i-user"></i>submenu</a><ul class="submenu"><li class="item"><a href="/page1/" rel="section"><i class="ic i-cloud"></i>link</a></li></ul></li><li class="item"><a href="/page2/" rel="section"><i class="ic i-coffee"></i>link2</a></li></div></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2024/01/13/3d-modeling/%E5%88%9D%E8%AF%86glsl/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2023/11/22/Video-Audio/%E5%B9%BB%E5%BD%B1%E5%9D%A6%E5%85%8B%E5%88%B6%E5%A4%87/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/Video-Audio/" title="分类于音视频开发">音视频开发</a></div><span><a href="/2023/11/07/Video-Audio/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%9F%BA%E7%A1%80/">二进制基础</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/project/" title="分类于项目">项目</a></div><span><a href="/2024/02/18/project/%E5%9C%B0%E7%90%83%E5%8F%AF%E8%A7%86%E5%8C%96/">地球可视化</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/algorithm/" title="分类于算法">算法</a></div><span><a href="/2023/08/02/algorithm/%E9%93%BE%E8%A1%A8%E8%BF%9B%E9%98%B6-%E8%AE%BA%E9%80%92%E5%BD%92%E5%9C%A8%E9%93%BE%E8%A1%A8%E4%B8%AD%E7%9A%84%E4%BD%9C%E7%94%A8/">链表进阶</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/3d-modeling/" title="分类于计算机图形学">计算机图形学</a></div><span><a href="/2024/01/23/3d-modeling/threejs%E5%90%AF%E5%8A%A8/">threejs启动</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Video-Audio/" title="分类于音视频开发">音视频开发</a></div><span><a href="/2023/11/14/Video-Audio/websocket%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/">websocket的基本使用</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/project/" title="分类于项目">项目</a></div><span><a href="/2024/02/25/project/3d%E7%9C%8B%E6%88%BF/">3d看房</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/algorithm/" title="分类于算法">算法</a></div><span><a href="/2023/07/17/algorithm/%E9%93%BE%E8%A1%A8%E5%9F%BA%E7%A1%80/">链表基础</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/3d-modeling/" title="分类于计算机图形学">计算机图形学</a></div><span><a href="/2024/01/14/3d-modeling/webgl%E7%BB%98%E5%88%B6%E7%82%B9/">webgl绘制点</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Video-Audio/" title="分类于音视频开发">音视频开发</a></div><span><a href="/2023/11/13/Video-Audio/canvas%E5%AF%B9%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86/">canvas对视频处理</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/project/" title="分类于项目">项目</a></div><span><a href="/2023/08/12/project/%E7%94%A8electron%E5%AE%9E%E7%8E%B0%E6%88%AA%E5%9B%BE%E5%8A%9F%E8%83%BD/">electron截图功能</a></span></li></ul></div><div class="rpost pjax"><h2>最新评论</h2><ul class="leancloud-recent-comment" id="new-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2022 -<span itemprop="copyrightYear">2024</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">SEELE-EXZzz(纯希) @ testName</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="站点总字数">159k 字</span><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="站点阅读时长">2:24</span></div><div class="powered-by">基于 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & Theme.<a href="https://github.com/theme-shoka-x/hexo-theme-shokaX/" rel="noopener" target="_blank">ShokaX</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2023/11/27/Video-Audio/端对端连接初体验/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,chart:!1,copy_tex:!1,katex:!1,mermaid:!1,audio:"",fancybox:!0,nocopy:!1,outime:!0,template:"&lt;div class=&quot;note warning&quot;&gt;&lt;p&gt;&lt;span class=&quot;label warning&quot;&gt;文章时效性提示&lt;/span&gt;&lt;br&gt;这是一篇发布于 {{publish}} 天前，最后一次更新在 {{updated}} 天前的文章，部分信息可能已经发生改变，请注意甄别。&lt;/p&gt;&lt;/div&gt;",quiz:{choice:"单选题",multiple:"多选题",true_false:"判断题",essay:"问答题",gap_fill:"填空题",mistake:"错题备注"},ignores:[t=>t.includes("#"),t=>new RegExp(LOCAL.path+"$").test(t),[]]}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=default,fetch"></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/pace/1.0.2/pace.min.js"></script><script src="https://unpkg.com/theme-shokax-pjax@latest/pjax.shokax.min.js"></script><script src="https://unpkg.com/theme-shokax-anime@latest/anime.shokax.min.js"></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/algoliasearch/4.12.1/algoliasearch-lite.umd.min.js"></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/instantsearch.js/4.39.0/instantsearch.production.min.js"></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/lozad.js/1.16.0/lozad.min.js"></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/quicklink/2.2.0/quicklink.umd.min.js"></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/??jquery/3.5.1/jquery.min.js,fancybox/3.5.7/jquery.fancybox.min.js,justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js" async></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/KaTeX/0.12.0/contrib/copy-tex.min.js" async></script><script src="https://unpkg.com/frappe-charts@1.5.0/dist/frappe-charts.min.iife.js"></script><script src="/js/app.js?v=0.2.10"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/assets/koharu.model.json"},display:{position:"right",width:300,height:600},mobile:{show:!1},log:!1})</script></body></html><!-- rebuild by hexo-renderer-multi-next-markdown-it -->